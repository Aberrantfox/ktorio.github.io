<form action="https://www.google.com/search" method="get">
<div class="page-inline-search" style="margin-bottom:8px;">
    <div class="input-group">
        <input name="q" id="search-input" type="text" class="form-control" placeholder="Search... (press 's' to focus, or '#' for sections)" data-placeholder-focus="Search... (use '↑', '↓' and '⏎' to select results)" data-placeholder-blur="Search... (press 's' to focus, or '#' for sections)" autocomplete="off">
        <input type="hidden" name="as_sitesearch" value="ktor.io" />
        <div class="input-group-btn">
            <button class="btn btn-default form-control" type="submit"><i class="glyphicon glyphicon-search"></i></button>
        </div>
    </div>

    <div class="search-results-inline-container">
        <ul id="search-results-container" class="search-results"></ul>
    </div>
</div>
</form>

<script type="text/javascript">
    String.prototype.normalizeForSearch = function() {
        return this.toLowerCase().replace(/[\s\/,.;\-]+/g, '');
    };

    String.prototype.escapeHTML = function() {
        return String(this)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    };

    Array.prototype.sorted = function(method) {
        let out = this.slice();
        out.sort(method);
        return out;
    };

    function comparerBy(selector) {
        return function(a, b) {
            let ra = selector(a), rb = selector(b);
            if (ra < rb) return -1;
            if (ra > rb) return +1;
            return 0;
        }
    }

    function composeComparers(...comparers) {
        return function(a, b) {
            for (const comparer of comparers) {
                const result = comparer(a, b);
                if (result !== 0) return result;
            }
            return 0;
        }
    }

    function sectionPriority(section) {
        switch (String(section).toLowerCase().replace(/\s+/, '')) {
            case 'quickstart': return 0;
            case 'servers': return 1;
            case 'clients': return 2;
            case 'features': return 3;
            case 'advanced': return 4;
            case 'samples': return 5;
            case 'drafts': return 6;
        }
        return 7;
    }

    async function fetchSearch() {
        //console.log('Fetching /search.json'.trim());
        let res = await fetch("/search.json");
        let results = await res.json();
        for (const result of results) {
            result.section = String(result.section);
            result.title = String(result.title);
            result.caption = String(result.caption);
            result.search = String('' + result.section + ' ' + result.title + ' ' + result.caption + ' ' + result.keywords).normalizeForSearch();
        }
        return results;
    }

    let fetchSearchPromise = null;

    async function fetchSearchOnce() {
        fetchSearchPromise = fetchSearchPromise || fetchSearch();
        return await fetchSearchPromise;
    }

    // Prefetch
    fetchSearchOnce();

    async function updateSearchResults() {
        let query = $('#search-input').val().trim();
        let containsHash = query.indexOf('#') >= 0;
        let querySearch = query.normalizeForSearch();
        let querySearchForSection = querySearch.replace(/#/g, '');
        let searchResults = $('#search-results-container');
        let results = await fetchSearchOnce();
        let lines = [];
        let filteredResults = results
            .sorted(composeComparers(
                comparerBy((it) => sectionPriority(it.section)),
                comparerBy((it) => String(it.search))
            ))
            .filter((it) => String(it.search).match(querySearch))
            .slice(0, 10)
        ;

        $(".doc-content").find("h2,h3,h4,h5,h6").filter("[id]").each(function () {
            const id = $(this).attr('id');
            const headerText = $(this).text();

            const searchTextLC = `${headerText} ${id}`.normalizeForSearch();

            if (searchTextLC.match(querySearchForSection)) {
                lines.push(`<a href='#${id.escapeHTML()}'># ${headerText.escapeHTML()}</a>`);
            }
        });

        for (const result of filteredResults) {
            lines.push(`<a href="${result.url.escapeHTML()}" title="${result.title.escapeHTML()}"><span style="color:#777;">${result.section.escapeHTML()}</span> - ${result.title.escapeHTML()} - ${result.caption.escapeHTML()}</a>`);
        }
        if (query !== '' && !containsHash) {
            lines.push(`<a href="https://www.google.com/search?q=site:ktor.io+${encodeURIComponent(query.trim())}">Search <code>${query.trim().escapeHTML()}</code> in google site:ktor.io</a>`)
        }
        let outLines = [];
        for (let n = 0; n < lines.length; n++) {
            const line = lines[n];
            let active = (n === 0) ? ' active' : '';
            let google = (line.indexOf('google.com/search') >= 0) ? ' google-search' : '';
            outLines.push(`<li class="${active}${google}">${line}</li>`);
        }
        if (outLines.length === 0) {
            outLines.push('<li>No results found</li>');
        }
        searchResults.html(outLines.join(''));
    }

    $('#search-input').on('focus', function() {
        //console.log('focus');
        //search-results-container
        updateSearchResults();
    }).on('change', function() {
        //console.log('change');
        updateSearchResults();
    }).on('keyup', function(e) {
        //console.log('keyup');
        if ([13, 16, 20, 37, 38, 39, 40, 91].indexOf(e.which) < 0) {
            updateSearchResults();
        }
    });

    function gotoIdClearSearch(id) {
        console.log('clearSearch', id);
        $('#search-input').val('');
        if (window.jekyllSearch) {
            window.jekyllSearch.emptyResultsContainer();
        }

        document.location.href = '#' + id;
    }
</script>
