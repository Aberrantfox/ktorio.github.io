<form action="https://www.google.com/search" method="get">
<div class="page-inline-search" style="margin-bottom:8px;">
    <div class="input-group">
        <input name="q" id="search-input" type="text" class="form-control" placeholder="Search... (press 's' to focus, or '#' for sections)" data-placeholder-focus="Search... (use '↑', '↓' and '⏎' to select results)" data-placeholder-blur="Search... (press 's' to focus, or '#' for sections)" autocomplete="off">
        <input type="hidden" name="as_sitesearch" value="ktor.io" />
        <div class="input-group-btn">
            <button class="btn btn-default form-control" type="submit"><i class="glyphicon glyphicon-search"></i></button>
        </div>
    </div>

    <div class="search-results-inline-container">
        <ul id="search-results-container" class="search-results"></ul>
    </div>
</div>
</form>

<script type="text/javascript" src="{{ '/assets/js/jekyll-search.js' | prepend: site.baseurl }}"></script>

<script type="text/javascript">
    function sectionPriority(section) {
        switch (String(section).toLowerCase().replace(/\s+/, '')) {
            case 'quickstart': return 0;
            case 'servers': return 1;
            case 'clients': return 2;
            case 'features': return 3;
            case 'advanced': return 4;
            case 'samples': return 5;
            case 'drafts': return 6;
        }
        return 7;
    }

    function escapeHtml(unsafe) {
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function trim(str) {
        return String(str).replace(/^\s+/, '').replace(/\s+$/, '');
    }

    window.jekyllSearch = SimpleJekyllSearch.init({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results-container'),
        json: '{{ "/search.json" | prepend: site.baseurl }}',
        searchResultTemplate: '<li><a href="{url}" title="{title}" style="display:block;width:100%;"><span style="color:#777;">{section}:</span> {title} - {caption}</a></li>',
        //noResultsText: '<li>No results found.</li>',
        noResultsText: '',
        prependTextFunc: function(query) {
            var out = [];
            //$(".doc-content").find("h1,h2,h3,h4,h5,h6").filter("[id]").each(function() {
            $(".doc-content").find("h2,h3,h4,h5,h6").filter("[id]").each(function() {
                var id = $(this).attr('id');
                var headerText = $(this).text();

                var queryLC = String(query).toLowerCase().replace(/#/g, '').replace(/[ ,.;\-]+/g, '-');
                var searchTextLC = (headerText.toLowerCase() + ' ' + id.toLowerCase()).replace(/[ ,.;\-]+/g, '-');

                if (searchTextLC.match(queryLC)) {
                    //console.log('matches: ', headerText, this);
                    out.push("<li><a href='#" + escapeHtml(id) + "' onclick='gotoIdClearSearch(\"" + escapeHtml(id) + "\");'># " + escapeHtml(headerText) + "</a></li>");
                }
            });
            //console.log();
            return out.join("\n");
        },
        appendTextFunc: function(query) {
            //if (query.match('#')) return '';
            return '<li class="google-search"><a href="https://www.google.com/search?q=site:ktor.io+' + escapeHtml(encodeURIComponent(trim(query))) + '">Search <code>' + escapeHtml(trim(query)) + '</code> in google site:ktor.io</a></li>'
        },
        sortMiddleware: function(a, b) {
            var bpriority = sectionPriority(a.section);
            var apriority = sectionPriority(b.section);
            var pri = bpriority - apriority;
            if (pri != 0) return pri;
            var astr = String(a.caption);
            var bstr = String(b.caption);
            return astr.localeCompare(bstr)
        },
        limit: 10,
        fuzzy: false
    });

    function gotoIdClearSearch(id) {
        console.log('clearSearch', id);
        $('#search-input').val('');
        if (window.jekyllSearch) {
            window.jekyllSearch.emptyResultsContainer();
        }

        document.location.href = '#' + id;
    }
</script>
